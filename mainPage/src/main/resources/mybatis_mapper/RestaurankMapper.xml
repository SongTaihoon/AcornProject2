<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">      
        
<mapper namespace="com.project.mainPage.mapper.RestaurankMapper">
	<resultMap type="Restaurant" id="RestaurantMap">
		<id column="rest_rank" property="rest_rank"/>
		<result column="tourist" property="tourist"/>
		<result column="province" property="province"/>
		<result column="city" property="city"/>
		<result column="address2" property="address2"/>
		<result column="rest" property="rest"/>	
		<result column="views" property="views"/>	
		<result column="search" property="search"/>
		<result column="ranking" property="ranking"/>
		<!-- Restaurant : UsersDto = N : 1   -->	
		<association property="user" javaType="UserDto" foreignColumn="user_id">
			<id column="user_id" property="user_id"/>
			<result column="user_name" property="user_name"/>
			<result column="user_email" property="user_email"/>
			<result column="birth" property="birth"/>
		</association>
		<association property="category" javaType="Category" foreignColumn="category_id">
			<id column="category_id" property="category_id"/>
		</association>
		<collection property="restaurantImgs" javaType="java.util.ArrayList" ofType="RestaurantImg">
			<id column="restaurank_img_no" property="restaurank_img_no"/>
			<result column="img_path" property="img_path"/>
		</collection>		
	</resultMap>
	
	<!--  Restaurant List  -->
	<select id="selectListAll" resultMap="RestaurantMap">	
			SELECT r.*, 
		 	c.category_id,
		 	RANK() OVER(ORDER BY search DESC) AS ranking
		 	
			FROM RESTAURANT r
			
			LEFT JOIN CATEGORY c 
		    USING(category_id)
		     
			ORDER BY search DESC LIMIT #{startRow}, #{pageSize} 
	</select>
	<select id="selectPageAllCount" resultType="int">
		SELECT COUNT(*) FROM RESTAURANT
	</select>
	<!-- RESTAURANT Detail  -->
	<select id="selectDetailOne" resultMap="RestaurantMap" parameterType="int">
		SELECT r.*, 
			u.user_id, 
			u.user_name, 
			i.restaurank_img_no AS restaurank_img_no,
			i.img_path AS img_path,
			
		 	c.category_id
		 	
		 	FROM RESTAURANT r
		 	
		 	INNER JOIN USER u 
			USING(user_id)
			
		 	LEFT JOIN RESTAURANTIMG i 
			USING(rest_rank)
			
		 	LEFT JOIN CATEGORY c 
		    USING(category_id)
		 	
		 	WHERE rest_rank = #{restRank}
	</select>
	<!-- 조회수 -->
	<update id="updateViews" parameterType="int">
		UPDATE RESTAURANT SET 
			views = views + 1
			WHERE rest_rank = #{restRank}
	</update>
	<!-- 등록 -->
	<insert id="insertOne" parameterType="Restaurant"
	 		useGeneratedKeys="true" keyProperty="rest_rank">
		INSERT INTO RESTAURANT 
			( tourist, province, city, address2, category_id, search , user_id)
				VALUES (#{tourist}, #{province}, #{city}, #{address2}, #{category.category_id}, #{search}, #{user.user_id})
	</insert>
	<!-- 수정  -->
	<update id="updateOne" parameterType="Restaurant">
		UPDATE RESTAURANT SET 
				tourist = #{tourist},
				city = #{city},
				address2 = #{address2},
				search = #{search}
				WHERE rest_rank = #{rest_rank}
	</update>
	<!-- 삭제  -->
	<delete id="deleteOne" parameterType="int">
		DELETE FROM RESTAURANT 
			WHERE rest_rank = #{restRank}
	</delete>
</mapper>