<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.mainPage.mapper.ReplyMapper">
	<resultMap type="Reply" id="ReplyMap">
		<id column="reply_no" property="reply_no"/>
		<result column="title" property="title"/>
		<result column="contents" property="contents"/>
		<result column="post_time" property="post_time"/>
		<result column="img_path" property="img_path"/>
		<result column="board_no" property="board_no"/>
		<association property="user" javaType="UserDto">
			<id column="user_id" property="user_id"/>
		</association>
		<collection property="good_prefers" javaType="java.util.ArrayList" ofType="ReplyPrefer">
			<id column="good_reply_prefer_no" property="reply_prefer_no"/>
			<result column="good_reply_no" property="reply_no"/>
			<result column="good_prefer" property="prefer"/>
			<result column="good_user_id" property="user_id"/>
		</collection>
		<collection property="bad_prefers" javaType="java.util.ArrayList" ofType="ReplyPrefer">
			<id column="bad_reply_prefer_no" property="reply_prefer_no"/>
			<result column="bad_reply_no" property="reply_no"/>
			<result column="bad_prefer" property="prefer"/>
			<result column="bad_user_id" property="user_id"/>
		</collection>
	</resultMap>
	<select id="selectOneJoinPrefers" resultMap="ReplyMap" parameterType="int">
		SELECT r.*,
			g.reply_prefer_no good_reply_prefer_no,
			g.reply_no good_reply_no,
			g.prefer good_prefer,
			g.user_id good_user_id,
			b.reply_prefer_no bad_reply_prefer_no,
			b.reply_no bad_reply_no,
			b.prefer bad_prefer,
			b.user_id bad_user_id
			
			FROM REPLY r 
			LEFT JOIN (SELECT * FROM REPLY_PREFER WHERE prefer = true) g
			ON r.reply_no = g.reply_no
			
			LEFT JOIN (SELECT * FROM REPLY_PREFER WHERE prefer = false) b
			ON r.reply_no = b.reply_no
			
			WHERE r.reply_no = #{reply_no}
	</select>
	<select id="selectBoardNoPage" resultType="Reply">
		SELECT reply_no, 
			   title,
			   contents, 
			   post_time, 
			   img_path, 
			   board_no,
			   reply_no	as no,
			   user_id as 'user.user_id',
			   (SELECT COUNT(*) FROM REPLY_PREFER WHERE reply_no = no AND prefer = true) as good,
			   (SELECT COUNT(*) FROM REPLY_PREFER WHERE reply_no = no AND prefer = false) as bad
			   <if test="loginUsersId != null">
			   ,(SELECT prefer FROM REPLY_PREFER WHERE reply_no = no AND user_id = #{loginUsersId}) as prefer_active
			   </if>	
			   FROM REPLY 
			   WHERE board_no = #{boardNo}
			   ORDER BY reply_no DESC
			   LIMIT #{startRow}, #{pageSize}
	</select>
	<select id="selectBoardNoCount" resultType="int">
		SELECT COUNT(*) FROM REPLY WHERE board_no = #{boardNo}
	</select>
	<select id="selectBoardNo" resultType="Reply" parameterType="int">
		SELECT *, user_id 'user.user_id' FROM REPLY 
		WHERE board_no = #{boardNo}
	</select>
	<select id="selectOne" resultType="Reply" parameterType="int">
		SELECT *, user_id 'user.user_id' FROM REPLY WHERE reply_no = #{reply_no}
	</select>
	<select id="selectUserId" resultType="Reply" parameterType="String">
		SELECT *, user_id 'user.user_id' FROM REPLY WHERE user_id = #{user_id}
	</select>
	<insert id="insertOne" parameterType="Reply">
		INSERT INTO REPLY (title, img_path, contents, board_no, user_id) 
		VALUES (#{title}, #{img_path}, #{contents}, #{board_no}, #{user.user_id})
	</insert>
	<update id="updateOne" parameterType="Reply">
		UPDATE REPLY SET title = #{title}, img_path = #{img_path}, contents = #{contents} 
		WHERE reply_no = #{reply_no}
	</update>
	<delete id="deleteOne" parameterType="int">
		DELETE FROM REPLY WHERE reply_no = #{reply_no}
	</delete>
</mapper>